---
layout:     post
title:      "ng Form"
subtitle:   ""
date:       2017-05-01 12:00:00
author:     "Feng"
header-img: "img/post-bg-03.jpg"
---


done:
* 7-1
* 7-2
* 7-3
* 7-4
* 7-5 
* 7-6
* 7-7
* 7-8
* 7-11
to review or to do
   
* [imooc](http://coding.imooc.com/learn/list/94.html)
* [官网](https://angular.cn/docs/ts/latest/guide/forms.html)
* [Angular从0到1](http://www.jianshu.com/p/0f9edcd7d6c3)




![Alt text](./1493882715747.png)

![Alt text](./1493882767063.png)


to confrim (both form)
`(submit)`事件绑定在`form`元素上：
`<form [formGroup]="myForm" (submit)="onSubmit()">`


FormModule
ReactiveFormsModule




### 模版式表单

只能使用指令定义数据模型

指令： `ngForm`, `ngModel`, `ngMdodelGroup`,  (from  FormsModel模块)

ngModel:
	1. 双向数据绑定
	2. 标记一个html元素成为表单数据模型的一部分


ngForm => FormGroup
ngModel => FormControl
ngModelGroup => FormGroup

##### ngForm

* angular会默认给表单加一个`ngForm`指令，自动接管表单，mothod， action等默认属性无效，并且拦截默认submit事件，用(ngSubmit)事件代替
*  **`ngForm`** 指令隐式创建一个FormGroup类实例，这个类代表表单的数据模型，存储表单数据。
*  标有 **ngForm**指令的html标签会自动发现其所有带有**ngModel**指令的子元素，并且将他们的值添加到表单的数据模型中
* `ngForm`指令不一定要在form标签中，也可以作用在div中。
* 取消自动接管： 添加`ngNoForm`指令
* form可以被一个模板本地变量引用： `<form #f="ngForm" (ngSubmit)="onSubmit(f.value)"`， 以便在模板中访问：`<div>{{f.value | json}}</div>` 


##### ngModel
* `ngModel`隐式创建FormControl实例，这个类存储表单字段的值  
* 需要添加`name`属性，`name`属性的值就是`f.value`对象中的一个`key`
* 带有ngModel指令的元素，会将其value添加到ngForm(FormGroup)中
* `ngModel`创建的对象也可以通过模版本地变量来引用：
`<input #username="ngModel" />`  引用： `<div>{{username.value}}</div>`






























### 响应式表单

```
imports: [
    BrowserModule,
    FormsModule,   // 模版式表单， cli自动引入
    HttpModule,
    ReactiveFormsModule // 响应式表单模块
],
```
创建响应式表单
1. 创建数据模型
2. 使用指令将模版中的html元素连接到数据模型

* 数据模型：用来保存表单数据的数据结构，由FormControl, FromGroup, FormArray三个定义在angular Forms模块中的类组成
* 响应式表单使用与模版式表单完全不同的指令(from ReactiveFormModule),都是以`form`开头
* 响应式表单的数据不能通过模板变量引用，不能在模板中操作数据模型。而模板式表单中拿不到FormControl，FormGroup的引用，只能拿到表单的数据


##### FormControl
* 保存着与其关联的html元素当前的值、元素的校验状态、元素是否被修改过等信息
* 创建： `username: FormControl = new FormControl('Niki')`， FormControl的构造函数接收一个参数指定该formControl的初始值
* 构成表单的基本单位
* `formControl`指令不能用在`formGroup`的内部


##### FormGroup
* FormGroup一般代表整个表单或表单字段的一个固定子集：
			`<form [formGroup]="myForm" (submit)="onSubmit()">`

* 创建

	```typescript
	   myForm: FormGroup = new FormGroup({
	
	        username: new FormControl('Niki'),
	        dateRange:  new FormGroup({
	            start: new FormControl(),
	            end: new FormControl()
	        }),
	
	        emails:  new FormArray([
	            new FormControl('123@qq.com'),
	            new FormControl('456@qq.com'),
	            new FormControl('789@qq.com'),
	        ]),
	        1: new FormControl('world')
	    });
	
	```


##### FormArray
* 通常用来代表一个可以增长的字段集合

`<input type="text" class="form-control" [formControlName]="1">`

```
<ul formArrayName="emails">
     <li *ngFor="let e of this.myForm.get('emails').controls; let i = index;">
	    <input type="text" class="form-control" [formControlName]="i"> <!-- 这里需要使用属性绑定  [formontrolName] -->
    </li>
</ul>
```



<table width="90%">
    <tr>
        <td>类名</td>
        <td colspan="" align="center">指令</td>
        <td colspan="" align="center">指令(可以使用属性的名字来连接MV)</td>
    </tr>
    <tr>
        <td>FromGroup</td>
        <td>formGroup</td>
        <td>formGroupName</td>
    </tr>
    <tr>
        <td>FormControl</td>
        <td>formControl</td>
        <td>formControlName</td>
    </tr>
    <tr>
        <td>FormArray</td>
        <td></td>
        <td>formArrayName</td>
    </tr>
</table>


     



### 表单校验
* 校验器
* 校验响应式表单校验
* 校验板式表单校验

##### 校验器：一个方法
* 必须返回一个对象，这个对象有一个`string`类型的`key`属性
* 方法接收一个AbstractControl类型的参数
	

	```
	check(control: AbstractControl): { [key: string]: any } {
        return {
            'key': 'info'
        };
    }
	```

hasError的参数： (校验器返回的key, 字段名)

    return valid ? null : {'mobile': true};

hasError('mobile')


异步校验器

状态字段

touched & untouched: 用户是否访问过该字段（获取过焦点）
pristine & dirty: 用户是否修改过该字段

任何一个字段是touched或者dirty，则真个表单就是touched或dirty

pending： 异步校验中

![Alt text](./1494431683971.png)
![Alt text](./1494431712767.png)


模板表单校验

通过指令：`ng g d directives/mobileValidator`

指令相当于没有模板的组件，可作为html属性使用

`(ngSubmit)` or `(submit)`

adding appEqual:
![Alt text](./1494482801306.png)

模板式表单中不能在模板中使用表单的状态属性




	<input type="text" require pattern="[a-zA-z0-9]">

<pre>
<code style="max-height: 500px;">
;(function() {
  /**
   * **********************************element data list***********************************
   * data-pos-row: cell row position
   * data-pos-col: cell col position
   * data-content: cell status including 'empty', 'control', 'grid'
   * data-rowsize: only for gird cell or control cell
   * data-colsize: only for gird cell or control cell
   * data-grid-index: 
   * data-ctrlid: 
   * (rowspan & colspan)
   *
   ****************************************************************************************/

  var $parentGrid = $("#mygridhandler");
  var $currGrid = $parentGrid;
  var gridIndex = 1;
  var $currCell = null;

  var controls = [{
    id: 'one',
    name: 'control-1'
  }, {
    id: 'two',
    name: 'control-2'
  }, {
    id: 'three',
    name: 'control-3'
  }];


  /**
   * content of control list modal
   * @return {string}
   */

  var controlList = function() {
    var $content = $('<div><div>');
    $.each(controls, function(index, control) {
      $("<input type='radio'/>").attr({
        'id': "ctrl-" + (index + 1),
        'name': "control",
        'value': control.name,
        'data-ctrlid': control.id
      }).appendTo($content);
      $('<label></label>').attr('for', "ctrl-" + (index + 1)).html(control.name).appendTo($content).after("<br/>");
    });
    return $content.html();
  };

  var Grid = function($ele, opt) {

    this.$element = $ele;
    this.defaults = {
      rows: 3,
      cols: 3,
      isParent: false,
      url: '',
      width: 600,
      height: 500
    };
    this.options = $.extend({}, this.defaults, opt);
    this._init();
  };

  Grid.prototype = {

    $currentCell: null,

    timer: null,

    getCurrCell: function() {
      return this.$currentCell;
    },

    setCurrCell: function($cell) {
      this.$currentCell = $cell;
      return this.$currentCell;
    },

    isParent: function() {
      return this.options.isParent;
    },

    _init: function() {
      //layout init
      this._initGridLayout();
      this._initGridsData();
      this._initCellEvent();
    },

    _initGridLayout: function() {

      this.$element.css({
        'width': this.options.width + 'px',
        'height': this.options.height + 'px'
      });

      var rows = this.options.rows,
        cols = this.options.cols;
      for (var i = 1; i <= rows; i++) {
        var $row = $("<tr></tr>");
        for (var j = 1; j <= cols; j++) {
          var $cell = $('<td></td>');
          //initialize cell data
          /**
           * content type:
           * 1.empty
           * 2.control
           * 3.grid
           */
          $cell.attr({
            'data-pos-row': i,
            'data-pos-col': j,
            'data-content': 'empty'
          }).appendTo($row);
        }
        this.$element.append($row);
      }


      //Grid infomation
      $('#grid-rows').val(this.options.rows);
      $('#grid-cols').val(this.options.cols);

      $currGrid.on('selectstart', function() {
        return false;
      });
    },

    _initGridsData: function() {
      this.$element.data('rows', this.options.rows);
      this.$element.data('cols', this.options.cols);
      this.$element.data('width', this.options.width);
      this.$element.data('height', this.options.height);
    },

    _initCellEvent: function() {
      var gridObj = this;
      this.$element.children('tbody').on('click', '>tr>td', function(event) {
        event.stopPropagation();
        gridObj.$currentCell = $(this);
        var $cell = gridObj.$currentCell
        $cell.parents('table').find('td').removeClass('active-cell');
        $cell.addClass('active-cell');

        //show size,position
        //disable add button
        if ($cell.attr('data-content') !== 'empty') {
          $('#size-rows').val($cell.attr('data-rowsize'));
          $('#size-cols').val($cell.attr('data-colsize'));
          $('#position-row').val($cell.attr('data-pos-row'));
          $('#position-col').val($cell.attr('data-pos-col'));
          $('.size, .position').show();
          $('.add').addClass('disabled');
        } else {
          $('.add').removeClass('disabled');
          $('.size, .position').hide();
        }
      });

      this.$element.children('tbody').on('dblclick', '>tr>td', function(event) {
        event.stopPropagation();
        gridObj.$currentCell = $(this);
        var $cell = gridObj.$currentCell;
        var contentType = $cell.attr('data-content');
        if (contentType == 'control') {
          alert('请删除后再添加');
        } else if (contentType == 'empty') {
          gridObj.showControlList();
        } else {
          var index = $cell.attr('data-grid-index');
          gridObj.changeGrid(index);
        }
      });
    },

    getRows: function() {
      return $currGrid.data('rows') * 1;
    },

    getCols: function() {
      return $currGrid.data('cols') * 1;
    },

    addRow: function() {
      var orgRows = this.getRows();
      var orgCols = this.getCols();
      var $row = $("<tr></tr>");
      for (var j = 1; j <= orgCols; j++) {
        $('<td></td>').attr({
          'data-pos-row': orgRows + 1,
          'data-pos-col': j,
          'data-content': 'empty'
        }).appendTo($row);
      }
      $currGrid.append($row);
      $currGrid.data('rows', $currGrid.data('rows') * 1 + 1);

      this._resize();

    },

    delRow: function() {
      var orgCols = this.getCols();
      $lastRow = $currGrid.children('tbody').children('tr').last();
      $cellsInvolved = $lastRow.children('td');
      if (this._checkCells($cellsInvolved, false) === false) {
        return false;
      } else {
        for (var i = 0; i < $cellsInvolved.length; i++) {
          if ($cellsInvolved[i].style.display == 'none') {
            // occupied by the cell above
            return false;
          }
        }
        $lastRow.remove();
        $currGrid.data('rows', $currGrid.data('rows') - 1);
      }

      this._resize();
    },

    addCol: function(goalCols) {
      var orgCols = this.getCols();
      var $allRows = $currGrid.children('tbody').children('tr');
      $.each($allRows, function(index, row) {
        $("<td></td>").attr({
          'data-pos-row': index + 1,
          'data-pos-col': orgCols + 1,
          'data-content': 'empty'
        }).appendTo($(row));;
      });
      $currGrid.data('cols', $currGrid.data('cols') * 1 + 1);

      this._resize();
    },

    delCol: function(goalCols) {
      var $allRows = $currGrid.children('tbody').children('tr');
      var cellsInvolved = [];
      $.each($allRows, function(index, row) {
        $lastCell = $(this).children().last();
        /**
         * push DOM element
         */
        cellsInvolved.push($lastCell[0]);
      });
      if (this._checkCells(cellsInvolved, false) === false) {
        return false;
      } else {
        for (var i = 0; i < cellsInvolved.length; i++) {
          if (cellsInvolved[i].style.display == 'none') {
            // occupied by the left cell
            return false;
          }
        }
        $.each($allRows, function(index, row) {
          $(this).children().last().remove();
        });
      }
      $currGrid.data('cols', $currGrid.data('cols') - 1);
      this._resize();
    },

    /**
     * make sure the cells involved is empty and not hidden 
     * when one cell expand its size or delete one row or one column
     * @param  {[jQuery elements]} $cellsInvolved []
     * @return {[boolean]}                [description]
     */
    _checkCells: function($cellsInvolved, ignoreSelf) {
      var c = this.$currentCell;

      if ($cellsInvolved.length === 0) {
        return false;
      }
      var flag = true;
      $.each($cellsInvolved, function(index, cell) {

        if (ignoreSelf === true) {
          if ($(cell).attr('data-content') != "empty" /*|| $(cell)[0].style.display == 'none'*/ ) {
            if ($(cell).attr('data-pos-row') != c.attr('data-pos-row') || $(cell).attr('data-pos-col') != c.attr('data-pos-col')) {
              flag = false;
            }
          }
        } else {
          if ($(cell).attr('data-content') != "empty") {
            flag = false;
          }
        }
      });
      return flag;
    },

    /**
     * resize the width of the cells who has these controls
     */
    _resize: function() {
      var orgRows = this.getRows();
      var orgCols = this.getCols();

      var width = Math.floor($currGrid.data('width') / $currGrid.data('cols'));
      var height = Math.floor($currGrid.data('height') / $currGrid.data('rows'));

      $currGrid.find('td[data-content="empty"]').css({
        width: width + 'px',
        height: height + 'px'
      });

      var $contents = $currGrid.find('td[data-content!="empty"]');
      $.each($contents, function(index, cell) {
        $(this).css({
          width: width * $(this).attr('data-colsize') + 'px',
          height: height * $(this).attr('data-rowsize') + 'px'
        })
      });
    },

    //纵向位移
    rowTranspotion: function(orgPosRow, goalPosRow, rowsize, colsize) {


      /**
       * hide the cell on the goal position
       *
       */
      var $involvedRows = [];
      var $involvedCells = [];

      var $startRow = $currGrid.find('tr').eq(goalPosRow - 1);
      var $currRow = $startRow;
      var pointer = rowsize;
      while (pointer--) {
        $involvedRows.push($currRow);
        $currRow = $currRow.next();
      }

      var start = this.$currentCell.attr('data-pos-col') * 1 - 1;
      var end = start + colsize - 1;
      $.each($involvedRows, function(index, row) {
        for (var i = start; i <= end; i++) {
          $involvedCells.push($(row).children().eq(i)[0]);
        }
      });

      if (this._checkCells($involvedCells, true) === false) {
        alert('单元格不能重合');
        $('#position-row').val(orgPosRow);
        return false;
      }


      var $destCell = $($involvedCells[0]);

      $destCell.attr({
          'data-content': this.$currentCell.attr('data-content'),
          'data-rowsize': this.$currentCell.attr('data-rowsize'),
          'data-colsize': this.$currentCell.attr('data-colsize'),
          'data-ctrlid': this.$currentCell.attr('data-ctrlid'),
          'data-grid-index': this.$currentCell.attr('data-grid-index'),
          'rowspan': this.$currentCell.attr('rowspan'),
          'colspan': this.$currentCell.attr('colspan'),
        }).html(this.$currentCell.html()).addClass('active-cell')
        .css('height', this.$currentCell.css('height')).data('data-height', this.$currentCell.data('data-height'));

      $.each($involvedCells, function(index, cell) {
        $(cell).hide();
      });

      /**
       * show the cells on the original position
       *
       */

      var $involvedRows2 = [];
      var $involvedCells2 = [];
      var $startRow2 = $currGrid.find('tr').eq(orgPosRow - 1);
      var $currRow2 = $startRow2;
      var pointer = rowsize;
      while (pointer--) {
        $involvedRows2.push($currRow2);
        $currRow2 = $currRow2.next();
      }

      $.each($involvedRows2, function(index, row) {
        for (var i = start; i <= end; i++) {
          $(row).children().eq(i).show();
          $involvedCells2.push($(row).children().eq(i));
        }
      });

      this.$currentCell.attr({
        'data-content': 'empty',
        'rowspan': 1,
        'colspan': 1,
      }).removeAttr('data-colsize data-rowsize data-gird-index data-ctrlid').html('').removeClass('active-cell');


      $.each($involvedCells, function(index, cell1) {
        $.each($involvedCells2, function(index, cell2) {
          // if ($(cell1).attr('data-pos-row') == $(cell2).attr('data-pos-row') && $(cell1).attr('data-pos-col') == $(cell2).attr('data-pos-col')) {
          $(cell1).hide();
          // }
        });
      });

      $destCell.show();
      this.$currentCell = $destCell;


      var rows = $currGrid.data('rows') * 1;
      var height = Math.floor($currGrid.data('height') / rows);
      $currGrid.find('td').css('height', height + 'px');


      $destCell.css('height', $destCell.data('data-height') + 'px');


      this._resize();
    },

    //水平位移
    colTranspotion: function(orgPosCol, goalPosCol, rowsize, colsize) {

      /**
       * hide the cells on the goal position
       */

      //how come...
      $currCell = this.getCurrCell();


      var $cellsInvolved = [];
      var $rowsInvolved = [];

      var $currRow = this.$currentCell.parent();
      var pointer = rowsize;
      while (pointer--) {
        $rowsInvolved.push($currRow);
        $currRow = $currRow.next();
      }


      var start = goalPosCol;
      var end = start + colsize;

      $.each($rowsInvolved, function(index, row) {
        console.log(row[0], start, end);
        for (var i = start; i < end; i++) {
          $cellsInvolved.push(row.children().eq(i - 1));
        }
      });


      if (this._checkCells($cellsInvolved, true) === false) {
        alert('单元格不能重合');

        $('#position-col').val(orgPosCol);
        return false;
      }


      var $destCell = $($cellsInvolved[0]);

      $destCell.attr({
        'data-content': this.$currentCell.attr('data-content'),
        'data-rowsize': this.$currentCell.attr('data-rowsize'),
        'data-colsize': this.$currentCell.attr('data-colsize'),
        'data-ctrlid': this.$currentCell.attr('data-ctrlid'),
        'data-grid-index': this.$currentCell.attr('data-grid-index'),
        'rowspan': this.$currentCell.attr('rowspan'),
        'colspan': this.$currentCell.attr('colspan'),
      }).html(this.$currentCell.html()).addClass('active-cell');


      $.each($cellsInvolved, function(index, cell) {
        console.log(cell[0])
        $(cell).hide();
      });


      /**
       * show the cells on the original position
       *
       */

      var $involvedRows2 = [];
      var $involvedCells2 = [];
      var $startRow2 = $currCell.parent();
      var $currRow2 = $startRow2;
      var pointer = rowsize;
      while (pointer--) {
        $involvedRows2.push($currRow2);
        $currRow2 = $currRow2.next();
      }


      start = $currCell.attr('data-pos-col') * 1;
      end = start + colsize;

      console.log($currCell[0], start, end)


      $.each($involvedRows2, function(index, row) {
        for (var i = start; i < end; i++) {
          $(row).children().eq(i - 1).show();
          $involvedCells2.push($(row).children().eq(i - 1));
        }
      });

      this.$currentCell.attr({
        'data-content': 'empty',
        'rowspan': 1,
        'colspan': 1,
      }).removeAttr('data-colsize data-rowsize data-gird-index data-ctrlid').html('').removeClass('active-cell');


      $.each($cellsInvolved, function(index, cell1) {
        $.each($involvedCells2, function(index, cell2) {
          if ($(cell1).attr('data-pos-row') == $(cell2).attr('data-pos-row') && $(cell1).attr('data-pos-col') == $(cell2).attr('data-pos-col')) {
            $(cell1).hide();
          }
        });
      });

      $destCell.show();
      this.$currentCell = $destCell;

      this._resize();

    },


    showControlList: function() {
      var gridObj = this;
      popUp.confirm({
        'title': 'Control List',
        'content': controlList,
        'submit': function(view) {

          if ($('input[name="control"]:checked').length !== 0) {
            var controlId = $('input[name="control"]:checked').attr('data-ctrlid');
            gridObj.addControl(gridObj.$currentCell, $('input[name="control"]:checked').val(), controlId, false);
          }

          view.remove();

        }
      });

      $('input').iCheck({
        checkboxClass: 'icheckbox_square-blue',
        radioClass: 'iradio_square-blue',
      });
    },


    /**
     * add control name to the current cell
     * @param {[type]} $currentCell [description]
     * @param {string} controlName  [control.name]
     * @param {String(number)} controlId    ['control.id']
     * @param {boolean} auto      [auto added (true) or added by user (false)]
     */
    addControl: function($currentCell, controlName, controlId, auto) {
      $currentCell.html(controlName);
      $currentCell.attr({
        'data-content': 'control',
        'data-colsize': 1,
        'data-rowsize': 1,
        'data-ctrlid': controlId
      });

      $("#size-rows").val(1);
      $("#size-cols").val(1);
      $('#position-row').val(this.$currentCell.attr('data-pos-row'));
      $('#position-col').val(this.$currentCell.attr('data-pos-col'));

      if (auto === false) {
        $('.size, .position').show();
      }


      $('.add').addClass('disabled');

      this._resize();
    },


    /**
     *
     * @param {boolean} auto [auto added (true) or added by user (false)]
     */
    addGrid: function(auto) {

      this.$currentCell.html('<span class="glyphicon glyphicon-th"></span><span>Grid</span>')
        .attr({
          'data-content': 'grid',
          'data-rowsize': 1,
          'data-colsize': 1,
          'data-grid-index': gridIndex
        });
      $('#size-rows').val(1);
      $('#size-cols').val(1);
      $('#position-row').val(this.$currentCell.attr('data-pos-row'));
      $('#position-col').val(this.$currentCell.attr('data-pos-col'));


      if (auto === false) {
        $('.size, .position').show();
        this.createChildGrid();
      }

      $('.add').addClass('disabled');

      gridIndex++;
      $currGrid = $parentGrid;
      $('#grid-rows').val($parentGrid.data('rows'));
      $('#grid-cols').val($parentGrid.data('cols'));

      this._resize();
    },

    createChildGrid: function(grid) {
      console.log(grid)

      $currGrid = $('<table></table>').attr('id', 'child-grid-' + gridIndex)
        .css('display', 'none')
        .appendTo('#table-container');
      $currGrid.gridhandler({
        rows: arguments.length == 0 ? 3 : grid.gridinfo.rows,
        cols: arguments.length == 0 ? 3 : grid.gridinfo.cols,
        isparent: false,
        width: 600,
        height: 500
      });

      $('<li data-grid-index=' + gridIndex + '>' +
          '<span class=\"glyphicon glyphicon-th\"><span>' +
          '<span class=\"grid-name\">Grid</span>' +
          '</li>')
        .appendTo('#grid-list');


      $currGrid.on('selectstart', function() {
        return false;
      });


      var rows = $currGrid.data('rows') * 1;
      var height = Math.floor($currGrid.data('height') / rows);
      $currGrid.find('td').css('height', height + 'px');

      if (arguments.length === 0) {
        return;
      }

      //fill controls in child grids


      var controls = grid.gridinfo.control;


      $.each(controls, function(index, control) {

        var $row = $currGrid.find('tbody tr').eq(control.row - 1);
        var $cell = $row.find('td').eq(control.col - 1);
        $currCell = $currGrid.gridhandler('setCurrCell', $cell);
        $currGrid.gridhandler('addControl', $cell, control.name, control.ctrlid, true);

        for (var i = 1; i < control.rows; i++) {
          $currGrid.gridhandler('increaseRowSize', control.rows);
        }

        for (var j = 1; j < control.cols; j++) {
          $currGrid.gridhandler('increaseColSize');
        }
      });

      gridIndex++;
    },

    /**
     * get controls of parent gird
     */
    getControls: function() {
      var controls = [];

      var $controlCells = $parentGrid.find('td[data-content="control"]');
      $.each($controlCells, function(index, controlCell) {
        var control = {};
        control.ctrlid = $(controlCell).attr('data-ctrlid');
        control.row = $(controlCell).attr('data-pos-row');
        control.col = $(controlCell).attr('data-pos-col');
        control.rows = $(controlCell).attr('data-rowsize');
        control.cols = $(controlCell).attr('data-colsize');
        controls.push(control);
      });
      return controls;
    },

    getGrids: function() {
      var grids = [];

      var $gridCells = $parentGrid.find('td[data-content="grid"]');
      $.each($gridCells, function(index, val) {
        var grid = {};
        grid.row = $(val).attr('data-pos-row');
        grid.col = $(val).attr('data-pos-col');
        grid.rows = $(val).attr('data-rowsize');
        grid.cols = $(val).attr('data-colsize');
        grid.gridinfo = {};

        var index = $(val).attr('data-grid-index');
        $childGrid = $('#child-grid-' + index);
        grid.gridinfo.rows = $childGrid.data('rows');
        grid.gridinfo.cols = $childGrid.data('cols');

        //get controls of child grid
        grid.gridinfo.controls = [];
        var $controlCells = $childGrid.find('td[data-content="control"]');
        $.each($controlCells, function(index, val) {
          var control = {};
          control.ctrlid = $(val).attr('data-ctrlid');
          control.row = $(val).attr('data-pos-row');
          control.col = $(val).attr('data-pos-col');
          control.rows = $(val).attr('data-rowsize');
          control.cols = $(val).attr('data-colsize');
          grid.gridinfo.controls.push(control);
        });


        grids.push(grid);
      });
      return grids;
    },


    increaseColSize: function() {
      var $currentRow = this.$currentCell.parent();
      var orgRowSize = parseInt(this.$currentCell.attr('data-rowsize'));
      var orgColSize = parseInt(this.$currentCell.attr('data-colsize'));

      var $rowsInvolved = [];
      var $cellsInvolved = [];

      while (orgRowSize--) {
        $rowsInvolved.push($currentRow);
        $currentRow = $currentRow.next();
      }
      var currPos = parseInt(this.$currentCell.attr('data-pos-col'));
      var newPos = currPos + orgColSize;

      $.each($rowsInvolved, function(index, val) {
        /**
         * push DOM element
         */
        $cellsInvolved.push(val.find('[data-pos-col=' + newPos + ']')[0]);
      });

      if (this._checkCells($cellsInvolved, false) === false) {
        return false;
      } else {
        $.each($rowsInvolved, function(index, val) {
          val.find('[data-pos-col=' + newPos + ']').hide();
        });
      }

      this.$currentCell.attr('colspan', orgColSize + 1);
      this.$currentCell.attr('data-colsize', orgColSize + 1);

      this._resize();
    },

    decreaseColSize: function() {
      var $currentRow = this.$currentCell.parent();
      var orgRowSize = parseInt(this.$currentCell.attr('data-rowsize'));
      var orgColSize = parseInt(this.$currentCell.attr('data-colsize'));
      var currColIndex = parseInt(this.$currentCell.attr('data-pos-col')) + 1;
      var $rowsInvolved = [];
      while (orgRowSize--) {
        $rowsInvolved.push($currentRow);
        $currentRow = $currentRow.next();
      }
      var lastCol = currColIndex + orgColSize - 2;
      $.each($rowsInvolved, function(index, val) {
        val.find('[data-pos-col=' + lastCol + ']').show();
      });

      this.$currentCell.attr('colspan', orgColSize - 1);
      this.$currentCell.attr('data-colsize', orgColSize - 1);

      this._resize();
    },

    increaseRowSize: function(goalRows) {


      var $currentRow = this.$currentCell.parent();
      var orgRowSize = parseInt(this.$currentCell.attr('data-rowsize'));
      var orgColSize = parseInt(this.$currentCell.attr('data-colsize'));

      var $cellsInvolved = [];
      var pointer = orgRowSize;
      while (pointer--) {
        $currentRow = $currentRow.next();
      }


      var start = parseInt(this.$currentCell.attr('data-pos-col'));
      var end = start + orgColSize;

      //
      if (goalRows == this.getRows()) {
        this.$currentCell[0].style.width = this.$currentCell[0].offsetWidth + 'px';
      }
      for (var i = start; i < end; i++) {
        /**
         * push DOM element
         */
        $cellsInvolved.push($currentRow.find("[data-pos-col=" + i + "]")[0]);
      }
      if (this._checkCells($cellsInvolved, false) === true) {

        $.each($cellsInvolved, function(index, val) {
          $(val).hide();
        });
      } else {

        return false;
      }


      this.$currentCell.attr('rowspan', orgRowSize + 1);
      this.$currentCell.attr('data-rowsize', orgRowSize + 1);

      this._resize();
    },

    decreaseRowSize: function() {
      var $currentRow = this.$currentCell.parent();
      var orgRowSize = parseInt(this.$currentCell.attr('data-rowsize'));
      var orgColSize = parseInt(this.$currentCell.attr('data-colsize'));

      var $cellsInvolved = [];
      var pointer = orgRowSize;
      while (--pointer) {
        $currentRow = $currentRow.next();
      }
      var start = parseInt(this.$currentCell.attr('data-pos-col'));
      var end = start + orgColSize;

      for (var i = start; i < end; i++) {
        $currentRow.find("[data-pos-col=" + i + "]").show();
      }

      this.$currentCell.attr('rowspan', orgRowSize - 1);
      this.$currentCell.attr('data-rowsize', orgRowSize - 1);

      this._resize();
    },

    remove: function(index) {
      var $currentRow = this.$currentCell.parent();
      var orgRowSize = this.$currentCell.attr('data-rowsize');
      var orgColSize = this.$currentCell.attr('data-colsize');
      var start = this.$currentCell.attr('data-pos-col') * 1;
      var end = start + orgColSize;

      var pointer = orgRowSize;
      while (pointer--) {
        for (var i = start; i < end; i++) {
          $currentRow.find("[data-pos-col=" + i + "]").show();
        }
        $currentRow = $currentRow.next();
      }

      //remove from grid list
      if (this.$currentCell.attr('data-content') == 'grid') {
        $('#grid-list').find('[data-grid-index=' + index + ']').remove();
      }

      this.$currentCell.removeAttr('rowspan colspan data-rowsize data-colsize data-grid-index data-ctrlid')
        .empty().removeClass('active-cell')
        .attr('data-content', 'empty');

      $('.size, .position').hide();

      this._resize();

    },

    changeGrid: function(index) {
      if (index !== 0) {
        $('#table-container').find('#child-grid-' + index).show().siblings('table').hide();
        $currGrid = $('#child-grid-' + index);
      } else {

        $parentGrid.show().siblings('table').hide();
        $currGrid = $parentGrid;
      }

      $('.size, .position').hide();
      $('#grid-rows').val($currGrid.data('rows'));
      $('#grid-cols').val($currGrid.data('cols'));
    }
  };


  $.fn.gridhandler = function(opt) {
    var value;
    var args = Array.prototype.slice.call(arguments, 1);
    var data = this.data('gridhandler');
    if (typeof opt === 'string') {
      if (!data) {
        console.error('cannot read gridhandler obj');
        return;
      }
      value = data[opt].apply(data, args);
    }

    if (!data) {
      this.data('gridhandler', (data = new Grid(this, opt)));
    }
    return typeof value === 'undefined' ? this : value;
  };

  $(function() {
    var gridPage = {

      loadPageData: [{

        "id": "p-1",
        "name": "page-1",
        "background": "image",
        "rows": "7",
        "cols": "3",
        "control": [{
          "ctrlid": "3",
          "name": "control-1",
          "row": "1",
          "col": "1",
          "rows": "1",
          "cols": "1"
        }, {
          "ctrlid": "5",
          "name": "control-2",
          "row": "7",
          "col": "1",
          "rows": "1",
          "cols": "1"
        }],
        "grid": [{
          "id": "g-1",
          "background": "image",
          "row": "2",
          "col": "1",
          "rows": "3",
          "cols": "1",
          "gridinfo": {
            "rows": "4",
            "cols": "2",
            "control": [{
              "ctrlid": "7",
              "name": "control-1",
              "row": "1",
              "col": "1",
              "rows": "1",
              "cols": "1"
            }, {
              "ctrlid": "11",
              "name": "control-2",
              "row": "1",
              "col": "1",
              "rows": "1",
              "cols": "1"
            }]
          }
        }, {
          "id": "g-2",
          "background": "image",
          "row": "5",
          "col": "1",
          "rows": "1",
          "cols": "1",
          "gridinfo": {
            "rows": "4",
            "cols": "1",
            "control": [{
              "name": "control-2",
              "ctrlid": "8",
              "row": "2",
              "col": "1",
              "rows": "2",
              "cols": "1"
            }]
          }
        }]
      }],

      submitPageData: [],

      minRows: 1,
      maxRows: 15,
      minCols: 1,
      maxCols: 5,

      init: function() {

        this.render();
        this.bindEvent();
        this.loadDataToGrid();
      },

      render: function() {

        this.$inputs = $('input');

        this.$gridRows = $('#grid-rows');
        this.$gridCols = $('#grid-cols');

        this.$sizeRows = $('#size-rows');
        this.$sizeCols = $('#size-cols');

        this.$posRow = $('#position-row');
        this.$posCol = $('#position-col');

        this.$addControl = $('#add-control');
        this.$addGrid = $('#add-grid');


        this.$gridList = $('#grid-list'); //child grid
        this.$parentGridLabel = $('.parent-grid-label'); //parent grid

        this.$remove = $('#remove');
        this.$saveGridData = $('#saveGridData');
      },

      bindEvent: function() {
        var me = this;
        this.$inputs.on('input', function() {
          $currCell = $currGrid.gridhandler('getCurrCell');
        });

        this.$gridRows.on('input', function() {
          var orgRows = $currGrid.gridhandler('getRows');
          var goalRows = parseInt($(this).val());
          if (goalRows > me.maxRows) {
            alert('不能大于 ' + me.maxRows + '行');
            $(this).val(orgRows);
            return false;
          }
          if (goalRows < me.minRows) {
            alert('不能小于 ' + me.minRows + '行');
            $(this).val(orgRows);
            return false;
          }

          if ($(this).val() === '') {
            return;
          }

          var newRows = goalRows - orgRows;
          if (newRows >= 0) {
            $(this).prev('.input-error').removeClass('show-err').addClass('hide-err');
            for (var i = 0; i < newRows; i++) {
              $currGrid.gridhandler("addRow");
            }
          } else {
            for (var i = newRows; i < 0; i++) {
              var result = $currGrid.gridhandler("delRow");
              if (result === false) {
                $(this).prev('.input-error').removeClass('hide-err').addClass('show-err');
                return false;
              }
            }
          }
        });

        this.$gridCols.on('input', function() {
          var orgCols = $currGrid.gridhandler('getCols');
          var goalCols = parseInt($(this).val());
          if (goalCols > me.maxCols) {
            alert('不能超过' + me.maxCols + '列');
            $(this).val(orgCols);
            return;
          }
          if (goalCols < me.minCols) {
            alert('不能小于' + me.minCols + '列');
            $(this).val(orgCols);
            return;
          }
          if ($(this).val() === '') {
            return;
          }

          var newCols = goalCols - orgCols;
          if (newCols >= 0) {
            $(this).prev('.input-error').removeClass('show-err').addClass('hide-err');
            for (var i = 0; i < newCols; i++) {
              $currGrid.gridhandler("addCol", goalCols);
            }
          } else {
            for (var i = newCols; i < 0; i++) {
              var result = $currGrid.gridhandler("delCol", goalCols);
              if (result === false) {
                $(this).prev('.input-error').removeClass('hide-err').addClass('show-err');
                break;
              }
            }
          }
        });

        this.$sizeRows.on('input', function() {
          var orgRowSize = parseInt($currCell.attr('data-rowsize'));
          var goalRows = parseInt($(this).val());
          var newRows = goalRows - orgRowSize;

          if ($(this).val() === '') {
            return;
          }
          if (newRows > 0) {

            for (var i = 0; i < newRows; i++) {
              var result = $currGrid.gridhandler('increaseRowSize', goalRows);
              if (result === false) {
                $(this).prev('.input-error').removeClass('hide-err').addClass('show-err');
                break;
              } else {}
            }
          }
          if (newRows <= 0) {
            $(this).prev('.input-error').removeClass('show-err').addClass('hide-err');
            for (var i = newRows; i < 0; i++) {
              $currGrid.gridhandler('decreaseRowSize');
            }

          }
        });

        this.$sizeCols.on('input', function() {
          var orgColSize = parseInt($currCell.attr('data-colsize'));
          var goalCols = parseInt($(this).val());
          var newCols = goalCols - orgColSize;

          if ($(this).val() === '') {
            return false;
          }
          if (goalCols <= 0) {
            alert('输入错误，请重新输入');
            $(this).val(orgColSize);
            return;
          }
          if (newCols > 0) {

            for (var i = 0; i < newCols; i++) {
              var result = $currGrid.gridhandler('increaseColSize');
              if (result === false) {
                $(this).prev('.input-error').removeClass('hide-err').addClass('show-err');
                break;
              }
            }
          }
          if (newCols <= 0) {
            $(this).prev('.input-error').removeClass('show-err').addClass('hide-err');
            for (var i = newCols; i < 0; i++) {
              $currGrid.gridhandler('decreaseColSize');
            }
          }

        });

        this.$posRow.on('input', function() {

          //get current rows in case  the cell overstep the grid
          var orgRows = $currGrid.gridhandler('getRows') * 1;

          var orgPosRow = $currCell.attr('data-pos-row') * 1;
          var goalPosRow = $(this).val() * 1;

          var rowsize = $currCell.attr('data-rowsize') * 1;
          var colsize = $currCell.attr('data-colsize') * 1;

          if ($(this).val() === '0' || goalPosRow < 0) {
            alert('输入错误，请重新输入');
            $(this).val(orgPosRow);
            return;
          }

          //'' * 1 = 0
          if (goalPosRow === 0 || goalPosRow == orgPosRow) {
            return;
          }

          if (goalPosRow > orgRows - rowsize + 1) {
            alert('超出范围啦');
            $(this).val(orgPosRow);
            return;
          }
          $currGrid.gridhandler('rowTranspotion', orgPosRow, goalPosRow, rowsize, colsize);
        });

        this.$posCol.on('input', function() {
          //get current cols in case  the cell overstep the grid
          var orgCols = $currGrid.gridhandler('getCols') * 1;

          var orgPosCol = $currCell.attr('data-pos-col') * 1;
          var goalPosCol = $(this).val() * 1;

          var rowsize = $currCell.attr('data-rowsize') * 1;
          var colsize = $currCell.attr('data-colsize') * 1;

          if ($(this).val() === '0' || goalPosCol < 0) {
            alert('输入错误，请重新输入');
            $(this).val(orgPosCol);
            return;
          }

          // '' * 1 = 0
          if (goalPosCol === 0 || goalPosCol == orgPosCol) {
            return;
          }

          if (goalPosCol > orgCols - colsize + 1) {
            alert('超出范围啦');
            $(this).val(orgPosCol);
            return;
          }
          $currGrid.gridhandler('colTranspotion', orgPosCol, goalPosCol, rowsize, colsize);
        });

        this.$addControl.click(function() {
          if ($(this).hasClass('disabled')) {
            return;
          }
          $currCell = $currGrid.gridhandler('getCurrCell');

          if ($currCell !== null) {
            $currGrid.gridhandler('showControlList');
          } else {
            alert('请选择单元格');
          }
        });

        this.$addGrid.click(function() {
          if ($(this).hasClass('disabled')) {
            return;
          }

          if ($currGrid.gridhandler('isParent') === false) {
            alert('子表格不能再添加子表格');
            return;
          }

          $currCell = $currGrid.gridhandler('getCurrCell');

          if ($currCell !== null) {
            $currGrid.gridhandler('addGrid', false);
          } else {
            alert('请选择单元格');
          }
        });

        this.$gridList.on('click', '>li', function() {
          var index = $(this).attr('data-grid-index');
          $currGrid.gridhandler('changeGrid', index);
        });

        this.$parentGridLabel.click(function() {
          $currGrid.gridhandler('changeGrid', 0);
        });

        this.$remove.click(function() {
          $currCell = $currGrid.gridhandler('getCurrCell');
          var index = $currCell.attr('data-grid-index');

          if ($currCell.attr('data-content') != 'empty') {
            $currGrid.gridhandler('remove', index);
          } else {
            return;
          }
        });

        this.$saveGridData.click(function() {
          var page = {};
          page.id = me.loadPageData[0].id;
          page.name = me.loadPageData[0].name;
          page.background = me.loadPageData[0].background;
          page.rows = $parentGrid.gridhandler('getRows');
          page.cols = $parentGrid.gridhandler('getCols');
          page.control = $parentGrid.gridhandler('getControls');
          page.grid = $parentGrid.gridhandler('getGrids');
          me.submitPageData[0] = page;
          console.log(me.submitPageData);

        })
      },

      loadDataToGrid: function() {

        /*$.ajax({
            url: '',
            type: 'get',
            dataType: 'json',
            async: false,
            success: function(data) {
                this.loadPageData = data;
            },
            error: function() {
                alert('error');
            }
        });*/


        //empty
        if (this.loadPageData.length === 0) {

          $currGrid.gridhandler({
            rows: 5,
            cols: 5,
            width: 600,
            height: 500,
            isParent: true
          });

          this.loadPageData = [{
            "id": "p-1",
            "name": "page-1",
            "background": "image",
            "rows": $parentGrid.gridhandler('getRows'),
            "cols": $parentGrid.gridhandler('getCols'),
            "control": [],
            "grid": []
          }];
          return;
        }

        var rows = this.loadPageData[0].rows;
        var cols = this.loadPageData[0].cols;
        var controls = this.loadPageData[0].control;
        var grids = this.loadPageData[0].grid;


        $currGrid.gridhandler({
          rows: rows,
          cols: cols,
          height: 500,
          width: 600,
          isParent: true
        });

        //fill contols
        $.each(controls, function(index, control) {

          var $row = $currGrid.find('tbody tr').eq(control.row - 1);
          var $cell = $row.find('td').eq(control.col - 1);
          $currCell = $currGrid.gridhandler('setCurrCell', $cell);

          $currGrid.gridhandler('addControl', $cell, control.name, control.ctrlid, true);


          for (var i = 1; i < control.rows; i++) {
            $currGrid.gridhandler('increaseRowSize', control.rows);
          }

          for (var j = 1; j < control.cols; j++) {
            $currGrid.gridhandler('increaseColSize');
          }
        });


        // fill grids
        $.each(grids, function(index, grid) {

          $currGrid = $parentGrid;
          var $row = $currGrid.find('tbody tr').eq(grid.row - 1);
          var $cell = $row.find('td').eq(grid.col - 1);
          $currCell = $currGrid.gridhandler('setCurrCell', $cell);
          console.log(grid)
          $currGrid.gridhandler('addGrid', true);

          //init
          $cell.attr({
            'data-content': 'grid',
            'data-colsize': 1,
            'data-rowsize': 1,
            'data-grid-index': index + 1
          });

          for (var i = 1; i < grid.rows; i++) {
            $currGrid.gridhandler('increaseRowSize', grid.rows);
          }

          for (var j = 1; j < grid.cols; j++) {
            $currGrid.gridhandler('increaseColSize');
          }

          $currCell = null;
          $currGrid.gridhandler('setCurrCell', null);
          $currGrid.gridhandler('createChildGrid', grid);
        });


        /**
         * set the current cell back to the parent grid after fill all child gird
         */
        $currGrid = $parentGrid;

        $('#grid-rows').val($currGrid.data('rows'));
        $('#grid-cols').val($currGrid.data('cols'));
      },
    };

    gridPage.init();
  });
})();
</code>
</pre>